{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "prefix": {
      "type": "string",
      "defaultValue": "vi",
      "metadata": {
        "description": "Prefix for the setup group."
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "",
      "allowedValues": [
        "dev",
        "staging",
        ""
      ],
      "metadata": {
        "description": "Deployment environment."
      }
    },
    "containerGroupName": {
      "type": "string",
      "defaultValue": "[concat(parameters('environment'), parameters('prefix'), 'agentscontainers')]",
      "metadata": {
        "description": "Container Group name."
      }
    },
    "storageAccountName": {
      "type": "string",
      "defaultValue": "[concat(parameters('environment'), parameters('prefix'), 'agentsstorage')]",
      "metadata": {
        "description": "Storage account name"
      }
    },
    "postgresServerName": {
      "type": "string",
      "defaultValue": "[concat(parameters('environment'), parameters('prefix'), 'agentsdb')]",
      "metadata": {
        "description": "PostgreSQL server name."
      }
    },
    "postgresAdminUsername": {
      "type": "string",
      "metadata": {
        "description": "PostgreSQL admin username."
      }
    },
    "postgresAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "PostgreSQL admin password."
      }
    }
  },
  "variables": {
    "container1name": "[concat(parameters('environment'), parameters('prefix'), '-agents-openwebui')]",
    "container1image": "ghcr.io/open-webui/open-webui:main"
  },
  "resources": [
    // Storage Account
    {
      "name": "[parameters('storageAccountName')]",
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2023-05-01",
      "tags": {
        "displayName": "viagentsstorage"
      },
      "location": "[resourceGroup().location]",
      "kind": "StorageV2",
      "sku": {
        "name": "Standard_LRS",
        "tier": "Standard"
      },
      "properties": {
        "supportsHttpsTrafficOnly": true,
        "isHnsEnabled": false,
        "allowSharedKeyAccess": true
      }
    },
    // File Share Default
    {
      "name": "[concat(parameters('storageAccountName'), '/default/', parameters('containerGroupName'), 'share')]",
      "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
      "apiVersion": "2023-05-01",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
      ],
      "properties": {
        "publicAccess": "None"
      }
    },
    // PostgreSQL Flexible Server
    {
      "type": "Microsoft.DBforPostgreSQL/flexibleServers",
      "apiVersion": "2025-01-01-preview",
      "name": "[parameters('postgresServerName')]",
      "location": "[resourceGroup().location]",
      "properties": {
        "administratorLogin": "[parameters('postgresAdminUsername')]",
        "administratorLoginPassword": "[parameters('postgresAdminPassword')]",
        "authConfig": {
          "activeDirectoryAuth": "Disabled",
          "passwordAuth": "Enabled"
        },
        "backup": {
          "backupRetentionDays": 7,
          "geoRedundantBackup": "Disabled"
        },
        "network": {
          "publicNetworkAccess": "Enabled"
        },
        "storage": {
          "storageSizeGB": 128,
          "tier": "P10",
          "autoGrowEnabled": false
        },
        "version": "17"
      },
      "sku": {
        "name": "Standard_D2ds_v5",
        "tier": "GeneralPurpose"
      }
    },
    // Container Group for opwebui
    {
      "name": "[variables('container1name')]",
      "type": "Microsoft.ContainerInstance/containerGroups",
      "apiVersion": "2023-05-01",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts/fileServices/shares', parameters('storageAccountName'), 'default', concat(parameters('containerGroupName'), 'share'))]"
      ],
      "location": "[resourceGroup().location]",
      "properties": {
        "containers": [
          {
            "name": "[variables('container1name')]",
            "properties": {
              "image": "[variables('container1image')]",
              "environmentVariables": [
                {
                  "name": "PORT",
                  "value": "80"
                },
                {
                  "name": "AIOHTTP_CLIENT_TIMEOUT",
                  "value": "600"
                }
              ],
              "ports": [
                {
                  "port": 80
                }
              ],
              "resources": {
                "requests": {
                  "cpu": 1,
                  "memoryInGB": 1
                }
              },
              "volumeMounts": [
                {
                  "name": "default",
                  "mountPath": "/app/backend/data"
                }
              ]
            }
          }
        ],
        "osType": "Linux",
        "ipAddress": {
          "type": "Public",
          "ports": [
            {
              "port": 80,
              "protocol": "TCP"
            }
          ]
        },
        "volumes": [
          {
            "name": "default",
            "azureFile": {
              "shareName": "[concat(parameters('containerGroupName'), 'share')]",
              "storageAccountName": "[parameters('storageAccountName')]",
              "storageAccountKey": "[listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName')), '2023-05-01').keys[0].value]"
            }
          }
        ]
      }
    }
  ],
  "outputs": {}
}